---
import { getCollection } from 'astro:content';

export async function getStaticPaths({ paginate }) {
	const posts = (await getCollection('blog')).sort(
		(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);
	return paginate(posts, { pageSize: 12 });
}

import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const { page } = Astro.props;
---

<!doctype html>
<html lang="zh-TW">
	<head>
		<BaseHead title={`ÊñáÁ´† - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
		<style is:global>
			.posts-container {
				max-width: 1200px;
				margin: 3rem auto;
			}

			.page-title {
				font-size: 2.5rem;
				margin-bottom: 3rem;
				font-weight: 700;
				color: #2c3e50;
				text-align: center;
			}

			.posts-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
				gap: 2rem;
			}

			.post-card {
				background: white;
				border-radius: 12px;
				overflow: hidden;
				transition: transform 0.2s, box-shadow 0.2s;
			}

			.post-card:hover {
				transform: translateY(-4px);
				box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
			}

			.post-card a {
				text-decoration: none;
				color: inherit;
				display: block;
			}

			.post-card-image {
				width: 100%;
				height: 200px;
				object-fit: cover;
			}

			.post-card-content {
				padding: 1.5rem;
			}

			.post-card-title {
				font-size: 1.25rem;
				font-weight: 600;
				color: #2c3e50;
				margin-bottom: 0.75rem;
				line-height: 1.4;
			}

			.post-card-title:hover {
				color: #3498db;
			}

			.post-card-meta {
				font-size: 0.85rem;
				color: #999;
				margin-bottom: 0.75rem;
				display: flex;
				align-items: center;
				gap: 0.25rem;
			}

			.post-card-meta .category-link {
				color: #666;
				text-decoration: none;
				transition: color 0.2s;
			}

			.post-card-meta .category-link:hover {
				color: #3498db;
			}

			.post-card-meta .separator {
				color: #ccc;
			}

			.post-card-description {
				font-size: 0.95rem;
				color: #666;
				line-height: 1.6;
				display: -webkit-box;
				-webkit-line-clamp: 3;
				-webkit-box-orient: vertical;
				overflow: hidden;
			}

			.post-card-category {
				margin-top: 0.75rem;
				margin-bottom: 0.25rem;
			}

			.post-card-tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
				margin-top: 0.75rem;
			}

			.category-badge, .tag-badge {
				display: inline-block;
				padding: 0.25rem 0.65rem;
				border-radius: 15px;
				font-size: 0.75rem;
				text-decoration: none;
				transition: all 0.2s;
			}

			.category-badge {
				background: #3498db;
				color: white;
			}

			.category-badge:hover {
				background: #2980b9;
			}

			.tag-badge {
				background: #f0f0f0;
				color: #666;
			}

			.tag-badge:hover {
				background: #e0e0e0;
				color: #333;
			}

			/* Pagination */
			.pagination {
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 1rem;
				margin-top: 4rem;
				padding-top: 2rem;
				border-top: 1px solid #e0e0e0;
			}

			.pagination a,
			.pagination span {
				padding: 0.5rem 1rem;
				border-radius: 6px;
				text-decoration: none;
				color: #666;
				transition: all 0.2s;
			}

			.pagination a:hover {
				background: #f0f0f0;
				color: #3498db;
			}

			.pagination .current {
				background: #3498db;
				color: white;
				font-weight: 600;
			}

			.pagination .disabled {
				color: #ccc;
				cursor: not-allowed;
			}

			.page-info {
				color: #999;
				font-size: 0.9rem;
			}

			/* Infinite scroll indicators */
			.loading-indicator,
			.end-message {
				text-align: center;
				padding: 3rem 1rem;
				margin-top: 2rem;
			}

			.spinner {
				width: 40px;
				height: 40px;
				margin: 0 auto 1rem;
				border: 4px solid #f0f0f0;
				border-top-color: #3498db;
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}

			.loading-indicator p {
				color: #999;
				font-size: 1rem;
			}

			.end-message p {
				color: #999;
				font-size: 1.1rem;
				font-weight: 500;
			}

			@media (max-width: 720px) {
				.posts-container {
					margin: 2rem auto;
				}

				.page-title {
					font-size: 2rem;
					margin-bottom: 2rem;
				}

				.posts-grid {
					grid-template-columns: 1fr;
				}

				.pagination {
					gap: 0.5rem;
					flex-wrap: wrap;
				}

				.pagination a,
				.pagination span {
					padding: 0.4rem 0.8rem;
					font-size: 0.9rem;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<div class="posts-container">
				<h1 class="page-title">ÊâÄÊúâÊñáÁ´†</h1>
				<Breadcrumb items={[
					{ label: 'È¶ñÈ†Å', href: '/' },
					{ label: 'ÊñáÁ´†' }
				]} />
				<div class="posts-grid">
					{
						page.data.map((post) => (
							<article class="post-card">
								<a href={`/blog/${post.id}/`}>
									<img src={post.data.heroImage} alt={post.data.title} class="post-card-image" />
									<div class="post-card-content">
										<h2 class="post-card-title">{post.data.title}</h2>
										<div class="post-card-meta">
											{post.data.category && (
												<>
													<a href={`/categories/${post.data.category}/`} class="category-link">
														{post.data.category}
													</a>
													<span class="separator"> | </span>
												</>
											)}
											<FormattedDate date={post.data.pubDate} />
										</div>
										<p class="post-card-description">{post.data.description}</p>
										{post.data.tags && post.data.tags.length > 0 && (
											<div class="post-card-tags">
												{post.data.tags.slice(0, 3).map((tag) => (
													<a href={`/tags/${tag}/`} class="tag-badge">
														#{tag}
													</a>
												))}
											</div>
										)}
									</div>
								</a>
							</article>
						))
					}
				</div>

				<!-- Loading indicator for infinite scroll -->
				<div id="loading" class="loading-indicator" style="display: none;">
					<div class="spinner"></div>
					<p>ËºâÂÖ•Êõ¥Â§öÊñáÁ´†...</p>
				</div>

				<!-- End message -->
				<div id="end-message" class="end-message" style="display: none;">
					<p>Â∑≤Á∂ìÊ≤íÊúâÊõ¥Â§öÊñáÁ´†‰∫Ü üìö</p>
				</div>

				<!-- Pagination (fallback for non-JS) -->
				<nav class="pagination" id="pagination">
					{page.url.prev ? (
						<a href={page.url.prev}>‚Üê ‰∏ä‰∏ÄÈ†Å</a>
					) : (
						<span class="disabled">‚Üê ‰∏ä‰∏ÄÈ†Å</span>
					)}

					<span class="page-info">
						Á¨¨ {page.currentPage} / {page.lastPage} È†Å
					</span>

					{page.url.next ? (
						<a href={page.url.next}>‰∏ã‰∏ÄÈ†Å ‚Üí</a>
					) : (
						<span class="disabled">‰∏ã‰∏ÄÈ†Å ‚Üí</span>
					)}
				</nav>
			</div>
		</main>
		<Footer />

		<script define:vars={{ currentPage: page.currentPage, totalPages: page.lastPage }}>
			let page = currentPage;
			let isLoading = false;
			const postsGrid = document.querySelector('.posts-grid');
			const loading = document.getElementById('loading');
			const endMessage = document.getElementById('end-message');
			const pagination = document.getElementById('pagination');

			// Hide pagination on load if JS is enabled
			pagination.style.display = 'none';

			// Format date function to match FormattedDate component
			function formatDate(dateString) {
				const date = new Date(dateString);
				return date.toLocaleDateString('en-us', {
					year: 'numeric',
					month: 'short',
					day: 'numeric',
				});
			}

			// Create post card HTML - exact structure match
			function createPostCard(post) {
				const card = document.createElement('article');
				card.className = 'post-card';

				const link = document.createElement('a');
				link.href = `/blog/${post.id}/`;

				// Image
				const img = document.createElement('img');
				img.src = post.heroImage;
				img.alt = post.title;
				img.className = 'post-card-image';
				img.loading = 'lazy';

				// Content div
				const content = document.createElement('div');
				content.className = 'post-card-content';

				// Title
				const title = document.createElement('h2');
				title.className = 'post-card-title';
				title.textContent = post.title;

				// Meta div
				const meta = document.createElement('div');
				meta.className = 'post-card-meta';

				// Category link if exists
				if (post.category) {
					const categoryLink = document.createElement('a');
					categoryLink.href = `/categories/${post.category}/`;
					categoryLink.className = 'category-link';
					categoryLink.textContent = post.category;
					meta.appendChild(categoryLink);

					const separator = document.createElement('span');
					separator.className = 'separator';
					separator.textContent = ' | ';
					meta.appendChild(separator);
				}

				// Date
				const time = document.createElement('time');
				time.dateTime = post.pubDate;
				time.textContent = formatDate(post.pubDate);
				meta.appendChild(time);

				// Description
				const description = document.createElement('p');
				description.className = 'post-card-description';
				description.textContent = post.description;

				// Append to content
				content.appendChild(title);
				content.appendChild(meta);
				content.appendChild(description);

				// Tags if exists
				if (post.tags && post.tags.length > 0) {
					const tagsDiv = document.createElement('div');
					tagsDiv.className = 'post-card-tags';

					post.tags.slice(0, 3).forEach(tag => {
						const tagLink = document.createElement('a');
						tagLink.href = `/tags/${tag}/`;
						tagLink.className = 'tag-badge';
						tagLink.textContent = `#${tag}`;
						tagsDiv.appendChild(tagLink);
					});

					content.appendChild(tagsDiv);
				}

				// Assemble
				link.appendChild(img);
				link.appendChild(content);
				card.appendChild(link);

				return card;
			}

			// Load more posts
			async function loadMore() {
				if (isLoading || page >= totalPages) return;

				isLoading = true;
				loading.style.display = 'block';

				try {
					// Let spinner rotate at least once (1 second minimum)
					const [response] = await Promise.all([
						fetch(`/api/posts.json?page=${page + 1}`),
						new Promise(resolve => setTimeout(resolve, 1000))
					]);

					const data = await response.json();

					data.posts.forEach(post => {
						const postCard = createPostCard(post);
						postsGrid.appendChild(postCard);
					});

					page++;

					if (!data.hasMore) {
						endMessage.style.display = 'block';
						window.removeEventListener('scroll', handleScroll);
					}
				} catch (error) {
					console.error('Failed to load posts:', error);
				} finally {
					isLoading = false;
					loading.style.display = 'none';
				}
			}

			// Handle scroll event
			function handleScroll() {
				const scrollPosition = window.innerHeight + window.scrollY;
				const threshold = document.documentElement.scrollHeight - 800;

				if (scrollPosition >= threshold) {
					loadMore();
				}
			}

			// Add scroll listener
			window.addEventListener('scroll', handleScroll);
		</script>
	</body>
</html>
